<extend name="Public/basic" />
<block name="body">
	<div class="main">
		<form id="payform" action="{:U()}" enctype="multipart/form-data" method="post" class="form-horizontal form ng-pristine ng-valid ng-scope" onsubmit="return validate();" ng-controller="paySetting">
			<div class="panel panel-default">
				<div class="panel-heading">
					设置支付宝支付开关
				</div>
				<div class="panel-body">
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付宝无线支付</label>
						<div class="col-sm-9 col-xs-12">
							<div class="alert alert-warning">
								您的支付宝账号必须支持手机网页即时到账接口, 才能使用手机支付功能, <a href="https://b.alipay.com/order/productDetail.htm?productId=2013080604609688" target="_blank">申请及详情请查看这里</a>.
							</div>
							<label class="radio-inline">
								<input type="radio" name="alipay[switch]" value="1" class="ng-pristine ng-untouched ng-valid"> 开启
							</label>
							<label class="radio-inline">
								<input type="radio" name="alipay[switch]" value="0" class="ng-pristine ng-untouched ng-valid"> 关闭
							</label>
							<span class="help-block">是否使用支付宝无线支付</span>
							<input type="hidden" name="alipay[t]">
						</div>
					</div>
					<div ng-show="alipay.switch == 'true'">
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">收款支付宝账号</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="alipay[account]" class="form-control" value="{$alipay['account']}" autocomplete="off">
								<span class="help-block">如果开启兑换或交易功能，请填写真实有效的支付宝账号，用于收取用户以现金兑换交易积分的相关款项。如账号无效或安全码有误，将导致用户支付后无法正确对其积分账户自动充值，或进行正常的交易对其积分账户自动充值，或进行正常的交易。 如您没有支付宝帐号，<a href="https://memberprod.alipay.com/account/reg/enterpriseIndex.htm" target="_blank">请点击这里注册</a></span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">合作者身份</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="alipay[partner]" class="form-control" value="{$alipay['partner']}" autocomplete="off">
								<span class="help-block">支付宝签约用户请在此处填写支付宝分配给您的合作者身份，签约用户的手续费按照您与支付宝官方的签约协议为准。<br>如果您还未签约，<a href="https://memberprod.alipay.com/account/reg/enterpriseIndex.htm" target="_blank">请点击这里签约</a>；如果已签约,<a href="https://b.alipay.com/order/pidKey.htm?pid=2088501719138773&amp;product=fastpay" target="_blank">请点击这里获取PID、Key</a>;如果在签约时出现合同模板冲突，请咨询0571-88158090</span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">校验密钥</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="alipay[secret]" class="form-control" value="{$alipay['secret']}" autocomplete="off">
								<span class="help-block">支付宝签约用户可以在此处填写支付宝分配给您的交易安全校验码，此校验码您可以到支付宝官方的商家服务功能处查看</span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">模拟测试</label>
							<div class="col-sm-9 col-xs-12 form-control-static">
								<a href="javascript:;" id="tPost">交易模拟测试</a>
								<span class="help-block">本测试将模拟提交 0.01 元人民币的订单进行测试，如果提交后成功出现付款界面，说明您站点的支付宝功能可以正常使用</span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="panel panel-default">
				<div class="panel-heading">
					设置微信支付开关
				</div>
				<div class="panel-body">
					<div class="form-group">
						<label class="col-xs-12 col-sm-3 col-md-2 control-label">微信支付</label>
						<div class="col-sm-9 col-xs-12">
							<div class="alert alert-danger">
								因微信公众平台对部分认证订阅号开放申请微信支付的能力,系统在设置支付公众号时,认证的订阅号会出现在下拉选择框,请您根据自己的公众号类型进行选择。 <a href="https://mp.weixin.qq.com/cgi-bin/announce?action=getannouncement&amp;key=1430372687&amp;version=4&amp;lang=zh_CN" target="_blank">详情请查看这里（登陆公众号后可查看）</a>.
							</div>
							<div class="alert alert-warning">
								你必须向微信公众平台提交企业信息以及银行账户资料，审核通过并签约后才能使用微信支付功能 <a href="https://mp.weixin.qq.com/paymch/readtemplate?t=mp/business/faq_tmpl" target="_blank">申请及详情请查看这里</a>.
							</div>
							<div class="alert alert-warning">
								<p>微擎0.6支持微信支付接口，注意你的微擎访问地址一定不要写错了，这里我们用访问地址代替下面说明中出现的链接，申请微信支付的接口说明如下：</p>
								<br>
								<h4>JS API网页支付参数</h4>
								<p>支付授权目录: http://so.baguatan.cn/payment/wechat/</p>
								<p>支付请求实例: http://so.baguatan.cn/payment/wechat/pay.php</p>
								<p>共享收货地址: 选择"是"</p>
								<br>
								<h4>Native原生支付</h4>
								<p>支付回调URL: http://so.baguatan.cn/payment/wechat/native.php</p>
								<p>维权通知URL: http://so.baguatan.cn/payment/wechat/rights.php</p>
								<p>警告通知URL: http://so.baguatan.cn/payment/wechat/warning.php</p>
							</div>
							<label class="radio-inline">
								<input type="radio" name="wechat[switch]" value="1" onclick="$('.s').hide();$('#mchid').show();$('#apikey').show();" class="ng-pristine ng-untouched ng-valid"> 开启
							</label>
							<label class="radio-inline">
								<input type="radio" name="wechat[switch]" value="0" class="ng-pristine ng-untouched ng-valid"> 关闭
							</label>
							<span class="help-block">是否使用微信支付</span>
						</div>
					</div>
					<div ng-show="wechat.switch == 'true'">
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">接口类型</label>
							<div class="col-sm-9 col-xs-12">
								<label class="radio-inline" onclick="$('.s').show();$('#mchid').hide();$('#apikey').hide();">
									<input type="radio" name="wechat[version]" value="1"> 旧版
								</label>
								<label class="radio-inline" onclick="$('.s').hide();$('#mchid').show();$('#apikey').show();">
									<input type="radio" name="wechat[version]" value="2" checked="checked"> 新版(2014年9月之后申请的)
								</label>
								<span class="help-block">由于微信支付接口调整，需要根据申请时间来区分支付接口</span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">支付账号</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" class="form-control" name="wechat[account]" value="玩聚部落">
								<span class="help-block">请填写其中支持微信支付的账号并填写支付参数</span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">身份标识
								<br>(appId)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[appid]" class="form-control" value="{$wechat['appid']|trim}">
								<span class="help-block">公众号身份标识 </span>
							</div>
						</div>
						<div class="form-group">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">身份密钥
								<br>(appSecret)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[appSecret]" class="form-control" value="{$wechat['appSecret']|trim}">
								<span class="help-block">公众平台API(参考文档API 接口部分)的权限获取所需密钥Key </span>
							</div>
						</div>
						<div class="form-group s" style="display:none;">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">商户身份
								<br>(partnerId)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[partner]" class="form-control" value="{$wechat['partner']|trim}">
								<span class="help-block">财付通商户身份标识</span>
								<span class="help-block">公众号支付请求中用于加密的密钥Key</span>
							</div>
						</div>
						<div class="form-group s" style="display:none;">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">商户密钥
								<br>(partnerKey)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[partnerKey]" class="form-control" value="{$wechat['partnerKey']|trim}">
								<span class="help-block">财付通商户权限密钥Key</span>
							</div>
						</div>
						<div class="form-group" id="mchid">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">微信支付商户号(MchId)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[mchid]" class="form-control" value="{$wechat['mchid']|trim}">
								<span class="help-block">公众号支付请求中用于加密的密钥Key</span>
							</div>
						</div>
						<div class="form-group s" id="paySignKey" style="display:none;">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">通信密钥(paySignKey)</label>
							<div class="col-sm-9 col-xs-12">
								<input type="text" name="wechat[paySignKey]" class="form-control" value="{$wechat['paySignKey']|trim}">
								<span class="help-block">公众号支付请求中用于加密的密钥Key</span>
							</div>
						</div>
						<div class="form-group s" id="apikey">
							<label class="col-xs-12 col-sm-3 col-md-2 control-label">商户支付密钥(API密钥)</label>
							<div class="col-sm-9 col-xs-12">
								<div class="input-group">
									<input type="text" name="wechat[apikey]" id="apikey" class="form-control" maxlength="32" value="{$wechat['apikey']|trim}">
									<span onclick="tokenGen();" style="cursor:pointer" class="input-group-addon">生成新的</span>
								</div>
								<span class="help-block">此值需要手动在腾讯商户后台API密钥保持一致</span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="form-group col-sm-12">
				<input name="do-submit" type="submit" value="提交" class="btn btn-primary col-lg-1">
			</div>
		</form>
	</div>
</block>
<block name="script">
	<script type="text/javascript">
		setFromValue("alipay[switch]", {$alipay['switch']});
		setFromValue("wechat[switch]", {$wechat['switch']});
		setFromValue("wechat[switch]", {$wechat['version']|default=2});
		highlight_subnav("{:U('System/payment')}");
		//支付宝测试
		$("#tPost").click(function(){
			var $scope = angular.element('#payform').scope();
			if($scope.alipay.switch == 'true') {
				if($.trim($(':text[name="alipay[account]"]').val()) == '') {
					util.message('必须输入收款支付宝账号.', '', 'error');
					return false;
				}
				if($.trim($(':text[name="alipay[partner]"]').val()) == '') {
					util.message('必须输入合作者身份.', '', 'error');
					return false;
				}
				if($.trim($(':text[name="alipay[secret]"]').val()) == '') {
					util.message('必须输入收款支付宝账号.', '', 'error');
					return false;
				}
				if(confirm('你可能需要修改您的浏览器 User-Agent 来模拟手机浏览才能正常测试, 请确认已经修改好.')) {
					$(':hidden[name="alipay[t]"]').val('true');
					$('#payform')[0].submit();
				}
			}
		});
	</script>
</block>